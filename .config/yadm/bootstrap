#!/usr/bin/env bash
#
# Bootstrap script for setting up a new macOS/Linux machine.
# Idempotent — safe to run multiple times.
#

set -euo pipefail

# ---------------------------------------------------------------------------
# Helpers
# ---------------------------------------------------------------------------
RED='\033[0;31m'; YELLOW='\033[1;33m'; GREEN='\033[0;32m'; BLUE='\033[0;34m'; RESET='\033[0m'
info()  { printf "${BLUE}[info]${RESET}  %s\n" "$*"; }
ok()    { printf "${GREEN}[ok]${RESET}    %s\n" "$*"; }
warn()  { printf "${YELLOW}[warn]${RESET}  %s\n" "$*"; }
err()   { printf "${RED}[error]${RESET} %s\n" "$*" >&2; }
step()  { printf "\n${BLUE}══════════════════════════════════════${RESET}\n${BLUE} %s${RESET}\n${BLUE}══════════════════════════════════════${RESET}\n" "$*"; }

INSTALLED=()
SKIPPED=()

# ---------------------------------------------------------------------------
# Step 1 — Homebrew
# ---------------------------------------------------------------------------
step "Homebrew"
if command -v brew &>/dev/null; then
    ok "Homebrew already installed"
    SKIPPED+=("homebrew")
    info "Running brew update..."
    brew update
else
    if [[ "$(uname -s)" == "Darwin" ]]; then
        err "Homebrew is not installed."
        err "On macOS, install it manually (Xcode CLT requires user interaction):"
        err '  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
        exit 1
    else
        info "Installing Homebrew on Linux..."
        NONINTERACTIVE=1 bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        # Add brew to PATH for the rest of this script
        if [[ -f /home/linuxbrew/.linuxbrew/bin/brew ]]; then
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        fi
        ok "Homebrew installed"
        INSTALLED+=("homebrew")
    fi
fi

# ---------------------------------------------------------------------------
# Step 2 — Brewfile
# ---------------------------------------------------------------------------
step "Brewfile"
BREWFILE="$HOME/.config/homebrew/Brewfile"
if [[ -f "$BREWFILE" ]]; then
    info "Installing packages from $BREWFILE..."
    brew bundle --file "$BREWFILE"
    ok "Brewfile packages installed"
    INSTALLED+=("brewfile-packages")
else
    warn "Brewfile not found at $BREWFILE — skipping"
fi

# ---------------------------------------------------------------------------
# Step 3 — Java symlinks (macOS only)
# ---------------------------------------------------------------------------
step "Java symlinks"
if [[ "$(uname -s)" == "Darwin" ]]; then
    BREW_PREFIX="$(brew --prefix)"
    symlink_jdk() {
        local formula="$1"   # e.g. openjdk@17
        local link_name="$2" # e.g. openjdk-17.jdk
        local src="$BREW_PREFIX/opt/$formula/libexec/openjdk.jdk"
        local dest="/Library/Java/JavaVirtualMachines/$link_name"
        if [[ ! -d "$src" ]]; then
            warn "$formula not installed — skipping symlink"
            return
        fi
        if [[ -e "$dest" ]]; then
            ok "Symlink already exists: $dest"
            SKIPPED+=("jdk-symlink:$link_name")
        else
            info "Creating JDK symlink: $dest"
            sudo ln -sfn "$src" "$dest"
            ok "Symlinked $formula → $dest"
            INSTALLED+=("jdk-symlink:$link_name")
        fi
    }
    symlink_jdk "openjdk@17" "openjdk-17.jdk"
    symlink_jdk "openjdk"    "openjdk.jdk"
else
    info "Linux — no JDK symlinks needed (java available via PATH)"
fi

# ---------------------------------------------------------------------------
# Step 4 — Oh-My-Zsh
# ---------------------------------------------------------------------------
step "Oh-My-Zsh"
OMZ_DIR="${ZSH:-$HOME/.oh-my-zsh}"
if [[ -d "$OMZ_DIR" ]]; then
    ok "Oh-My-Zsh already installed at $OMZ_DIR"
    SKIPPED+=("oh-my-zsh")
else
    info "Installing Oh-My-Zsh..."
    RUNZSH=no CHSH=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    ok "Oh-My-Zsh installed"
    INSTALLED+=("oh-my-zsh")
fi

# ---------------------------------------------------------------------------
# Step 5 — OMZ plugins
# ---------------------------------------------------------------------------
step "Oh-My-Zsh plugins"
ZSH_CUSTOM="${ZSH_CUSTOM:-${ZSH:-$HOME/.oh-my-zsh}/custom}"

clone_plugin() {
    local name="$1"
    local url="$2"
    local dest="$ZSH_CUSTOM/plugins/$name"
    if [[ -d "$dest" ]]; then
        ok "Plugin already installed: $name"
        SKIPPED+=("plugin:$name")
    else
        info "Cloning plugin: $name"
        git clone --depth=1 "$url" "$dest"
        ok "Plugin installed: $name"
        INSTALLED+=("plugin:$name")
    fi
}

clone_plugin "zsh-autosuggestions"      "https://github.com/zsh-users/zsh-autosuggestions"
clone_plugin "zsh-syntax-highlighting"  "https://github.com/zsh-users/zsh-syntax-highlighting"
clone_plugin "fast-syntax-highlighting" "https://github.com/zdharma-continuum/fast-syntax-highlighting"

# ---------------------------------------------------------------------------
# Step 6 — Tmux Plugin Manager (TPM)
# ---------------------------------------------------------------------------
step "Tmux Plugin Manager"
TPM_DIR="$HOME/.tmux/plugins/tpm"
if [[ -d "$TPM_DIR" ]]; then
    ok "TPM already installed at $TPM_DIR"
    SKIPPED+=("tpm")
else
    info "Cloning TPM..."
    git clone --depth=1 https://github.com/tmux-plugins/tpm "$TPM_DIR"
    ok "TPM installed"
    INSTALLED+=("tpm")
fi

if [[ -f "$TPM_DIR/bin/install_plugins" ]]; then
    info "Installing tmux plugins via TPM..."
    "$TPM_DIR/bin/install_plugins" || warn "TPM install_plugins exited non-zero (tmux may not be running — plugins will install on next tmux session)"
fi

# ---------------------------------------------------------------------------
# Step 7 — Summary
# ---------------------------------------------------------------------------
step "Summary"
if [[ ${#INSTALLED[@]} -gt 0 ]]; then
    ok "Newly installed:"
    for item in "${INSTALLED[@]}"; do
        printf "    ${GREEN}+${RESET} %s\n" "$item"
    done
fi
if [[ ${#SKIPPED[@]} -gt 0 ]]; then
    info "Already present (skipped):"
    for item in "${SKIPPED[@]}"; do
        printf "    ${BLUE}·${RESET} %s\n" "$item"
    done
fi

printf "\n${GREEN}Bootstrap complete.${RESET}\n\n"
